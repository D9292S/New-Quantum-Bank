# Dependency Management Guide

This document explains how to properly manage dependencies for the Quantum Bank project.

## Understanding the Project Setup

The Quantum Bank project uses:

- **pyproject.toml**: Main dependency declaration file
- **requirements.txt**: Generated/frozen dependency file
- **uv.lock**: Lock file generated by uv package manager
- **.uv.toml**: UV package manager configuration file with cache directory set to `.uv-cache`

## Python Version Requirements

This project requires **Python 3.12 or higher**. The performance optimization modules and certain dependencies specifically require Python 3.12+, which is why we've set this as the minimum version.

If you encounter version compatibility issues, make sure you're using Python 3.12 or newer.

## Important Note on Discord Library

This project uses **py-cord** as its Discord API library but continues to use `import discord` in the code. This works because:

1. py-cord is a fork of discord.py that maintains API compatibility
2. py-cord installs itself to be importable via the `discord` namespace
3. This allows the code to work with either discord.py or py-cord

If you encounter any compatibility issues, please ensure you are using the correct version of py-cord (2.x+).

## Performance Optimization Dependencies

The project's performance optimization modules require several specific packages:

- **psutil**: Used for memory monitoring and management
- **expiringdict**: Used for implementing TTL-based caching
- **matplotlib**: Used for generating performance graphs
- **msgpack**: Used for efficient data serialization

These dependencies are included in the `dependencies` section of pyproject.toml and are automatically installed when you install the project.

For Heroku deployment, additional optimization packages are included in the `production` dependencies group:

```toml
production = [
    "psutil>=5.9.5,<6.0.0",
    "memory-profiler>=0.61.0,<1.0.0",
    "aiomonitor>=0.4.5,<1.0.0",
    "colorlog>=6.7.0,<7.0.0",
    'uvloop>=0.17.0,<0.21.0; platform_system != "Windows"',
    "aiodns>=3.0.0,<4.0.0",
    "cchardet>=2.1.7,<3.0.0",
    'pycurl>=7.45.2,<8.0.0; platform_system != "Windows"',
    "quantum-bank-bot[high-performance]",
]
```

## Note on Type Stubs

We've removed the `types-pymongo` dependency as it causes issues with dependency resolution in some environments. Instead, we've configured mypy to ignore missing imports for MongoDB-related packages:

```toml
[[tool.mypy.overrides]]
module = ["pymongo.*", "mongomock.*"]
ignore_missing_imports = true
```

This approach is sufficient for type checking without requiring the external type stubs package.

## Updating Dependencies

When you need to add or update a dependency:

1. **Edit pyproject.toml**:
   ```toml
   # In the dependencies section
   dependencies = [
       "new-package>=1.0.0",
       # other dependencies...
   ]

   # Or for dev dependencies
   [project.optional-dependencies]
   development = [
       "dev-package>=2.0.0",
       # other dev dependencies...
   ]
   ```

2. **Regenerate requirements.txt**:
   ```bash
   uv pip compile pyproject.toml --upgrade --output-file requirements.txt
   ```

3. **Update your environment using uv**:
   ```bash
   # Either using uv standard dependencies
   uv pip install -e .

   # Or for development dependencies
   uv pip install -e ".[development]"

   # Or for production dependencies
   uv pip install -e ".[production]"
   ```

## Common Issues

### Lock File Conflicts

If you manually edit pyproject.toml and see dependency conflicts:

```bash
# Regenerate the lock file
uv pip compile --dependencies=all

# Then reinstall the project
uv pip install -e .
```

### Missing Type Stubs

Some packages don't have type stubs available in PyPI. For these packages:

1. Add an override in the mypy section of pyproject.toml:
   ```toml
   [[tool.mypy.overrides]]
   module = ["problem_package.*"]
   ignore_missing_imports = true
   ```

2. Or install the specific stubs directly:
   ```bash
   uv pip install types-package-name
   ```

## Development Workflow

For development, we recommend:

1. Create a virtual environment:
   ```bash
   uv venv
   source .venv/bin/activate  # On Windows: .venv\Scripts\activate
   ```

2. Install development dependencies:
   ```bash
   uv pip install -e ".[development,testing]"
   ```

3. Install pre-commit hooks:
   ```bash
   pre-commit install
   ```

This ensures you have all the tools needed for development, testing, and code quality.

## Performance Considerations

When adding new dependencies, consider their impact on performance:

1. **Evaluate alternatives**: Consider if there are more lightweight alternatives available
2. **Check compatibility**: Ensure the package works correctly with Python 3.12+
3. **Test performance impact**: Use the performance testing tools in the `tools/` directory to benchmark before and after adding dependencies

For critical path operations, prefer standard library solutions when possible to reduce dependency overhead.

# Dependency Management with UV

This document outlines our dependency management practices using the UV package manager.

## Dependency Review Schedule

We follow a structured schedule for dependency reviews to ensure security and performance:

| Period | Review Type | Description | Responsible |
|--------|-------------|-------------|-------------|
| Weekly | Security Scan | Automated check for vulnerability alerts | CI System |
| Monthly | Update Check | Check for available updates and assess impact | Lead Developer |
| Quarterly | Full Review | Complete dependency audit with testing | Development Team |
| Pre-Release | Release Audit | Comprehensive review before major releases | Release Manager |

### Quarterly Review Checklist

For quarterly dependency reviews, follow this procedure:

1. **Scan for Vulnerabilities**
   ```bash
   pip-audit
   safety check
   ```

2. **Check for Updates**
   ```bash
   uv pip list --outdated
   ```

3. **Review Dependencies**
   - Review each dependency's purpose and necessity
   - Check for unmaintained packages
   - Look for better alternatives

4. **Test Updates**
   ```bash
   uv pip sync pyproject.toml --upgrade
   pytest tests/
   ```

5. **Document Changes**
   - Update `docs/DEPENDENCIES.md` with any changes
   - Document upgrade decisions

6. **Finalize Updates**
   ```bash
   uv pip sync pyproject.toml
   git commit -am "Quarterly dependency update [Q1/Q2/Q3/Q4 YYYY]"
   ```

## UV Package Management

UV is a high-performance Python package manager that significantly improves dependency management speed and reliability. We use it for all package operations in this project.

### Installation

UV can be installed using:

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

Or on Windows:

```bash
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### Common Commands

```bash
# Create a new virtual environment
uv venv

# Install all dependencies
uv pip sync pyproject.toml

# Add a specific package
uv pip install package_name

# Install only specific dependency groups
uv pip install -e ".[database,monitoring]"
```

## Dependency Groups

Dependencies are organized into logical groups in pyproject.toml:

- `database`: Database-related dependencies
- `monitoring`: Performance monitoring tools
- `features`: Feature flag system
- `datascience`: Data analysis libraries
- `optimizations`: Performance optimization
- `media`: Media processing
- `security`: Security components
- `testing`: Testing utilities
- `dev`: Development tools
- `all`: Everything for development
- `production`: Production deployment dependencies

## Version Pinning Strategy

We use the following version pinning strategy:

1. **Lower Bound**: Always specify a minimum version that meets our requirements
2. **Upper Bound**: Limit to the next major version to prevent breaking changes
3. **Example**: `package>=1.2.3,<2.0.0`

This approach balances security updates with stability.

## Adding New Dependencies

When adding a new dependency:

1. Evaluate necessity - could we use an existing dependency?
2. Check security history and maintenance status
3. Add to the appropriate dependency group in pyproject.toml
4. Document purpose in docs/DEPENDENCIES.md
5. Run `uv pip sync pyproject.toml` to update the lock file
6. Commit both pyproject.toml and the lock file

## Vulnerability Management

For security vulnerabilities:

1. Weekly automated scans with pip-audit and safety
2. Immediate updates for critical vulnerabilities
3. Scheduled updates for low-severity issues
4. Documentation of security-related changes

## CI/CD Integration

Our CI pipeline includes dependency checks:

1. Dependency validation on every PR
2. Security scanning weekly
3. Version conflict detection
4. License compliance checking
